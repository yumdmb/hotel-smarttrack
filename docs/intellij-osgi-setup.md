# IntelliJ IDEA OSGi Setup Guide

This guide provides step-by-step instructions to configure IntelliJ IDEA for OSGi development with the Hotel SmartTrack project.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Step 1: Download Apache Felix OSGi Framework](#step-1-download-apache-felix-osgi-framework)
- [Step 2: Install the OSGi Plugin in IntelliJ IDEA](#step-2-install-the-osgi-plugin-in-intellij-idea)
- [Step 3: Configure OSGi Framework in IntelliJ IDEA](#step-3-configure-osgi-framework-in-intellij-idea)
- [Step 4: Add OSGi Facet to Modules](#step-4-add-osgi-facet-to-modules)
- [Step 5: Create OSGi Run Configuration](#step-5-create-osgi-run-configuration)
- [How This Project Uses OSGi with Maven](#how-this-project-uses-osgi-with-maven)
- [Troubleshooting](#troubleshooting)

---

## Prerequisites

Before starting, ensure you have:

- IntelliJ IDEA installed (Community or Ultimate edition)
- Java 17+ JDK installed and configured
- The Hotel SmartTrack project cloned and opened in IntelliJ IDEA
- Maven installed (or use the bundled Maven in IntelliJ)

---

## Step 1: Download Apache Felix OSGi Framework

Apache Felix is a lightweight OSGi framework implementation. You need to download it to run OSGi bundles.

### Download Instructions

1. Go to the official Apache Felix download page:

   - **URL**: [https://felix.apache.org/downloads.cgi](https://felix.apache.org/downloads.cgi)

2. Download the **Felix Framework Distribution** (look for `org.apache.felix.main.distribution-X.X.X.zip`)

   - Example: `org.apache.felix.main.distribution-7.0.5.zip`

3. Extract the ZIP file to a location on your computer:

   - Recommended: `C:\tools\felix` (Windows) or `~/tools/felix` (macOS/Linux)

4. The extracted folder structure should look like:
   ```
   felix/
   ├── bin/
   ├── bundle/
   ├── conf/
   ├── doc/
   └── felix.jar
   ```

### Alternative: Eclipse Equinox

If you prefer Eclipse Equinox (used by Eclipse IDE):

- **URL**: [https://www.eclipse.org/equinox/](https://www.eclipse.org/equinox/)
- Download the "SDK" or "Framework Only" package

---

## Step 2: Install the OSGi Plugin in IntelliJ IDEA

OSGi support is **not included by default** in IntelliJ IDEA. You must install the OSGi plugin.

### Installation Steps

1. Open IntelliJ IDEA

2. Go to **File** -> **Settings** (Windows/Linux) or **IntelliJ IDEA** -> **Preferences** (macOS)

3. Navigate to **Plugins** in the left sidebar

4. Click the **Marketplace** tab

5. In the search box, type **"OSGi"**

6. Find the plugin named **"OSGi"** (by JetBrains)

7. Click **Install**

8. Restart IntelliJ IDEA when prompted

### Verify Installation

After restart:

1. Go to **File** -> **Settings** -> **Languages & Frameworks**
2. You should now see an **OSGi** option in the menu

---

## Step 3: Configure OSGi Framework in IntelliJ IDEA

Now you need to tell IntelliJ IDEA where your OSGi framework (Apache Felix) is located.

### Configuration Steps

1. Go to **File** -> **Settings** (or **Preferences** on macOS)

2. Navigate to **Languages & Frameworks** -> **OSGi**

3. In the **Framework Definitions** section, click the **+** (Add) button

4. In the dialog that appears:

   - **Name**: Enter a name like `Apache Felix 7.0.5`
   - **Home Directory**: Browse to your Felix installation folder (e.g., `C:\tools\felix`)

5. IntelliJ will automatically detect the framework JAR files

6. Click **OK** to save

7. Click **Apply** and then **OK** to close the settings

---

## Step 4: Add OSGi Facet to Modules

For IntelliJ to recognize your modules as OSGi bundles, you need to add the OSGi facet.

### For Each Bundle Module (smarttrack-guest, smarttrack-room, etc.)

1. Go to **File** -> **Project Structure** (or press `Ctrl+Alt+Shift+S`)

2. In the left panel, click **Facets**

3. Click the **+** (Add) button at the top

4. Select **OSGi** from the list

5. Choose the module to add the facet to (e.g., `smarttrack-guest`)

6. In the OSGi facet settings:

   - **Use existing manifest**: Enable this option
   - **Manifest file**: Leave as default (the plugin will use Maven-generated manifest)

7. Repeat for each bundle module:

   - `smarttrack-guest`
   - `smarttrack-room`
   - `smarttrack-reservation`
   - `smarttrack-stay`
   - `smarttrack-billing`
   - `smarttrack-base-library`

8. Click **Apply** and **OK**

### Important Note

Since this project uses Maven with `maven-bundle-plugin`, IntelliJ will read the manifest generated by Maven during builds. You don't need to manually create `MANIFEST.MF` files.

---

## Step 5: Create OSGi Run Configuration (Optional)

> [!IMPORTANT] > **This project does NOT run in a standalone OSGi container.** The Hotel SmartTrack application runs in **Spring Boot** (via `smarttrack-application`). OSGi is used for **build-time architecture enforcement** and **IDE support**, not as a runtime container.
>
> The OSGi facets you configured help IntelliJ understand your modular structure and enforce clean boundaries during development. To actually run the application, use Spring Boot: `mvn spring-boot:run`

If you want to experiment with running bundles in Felix (for learning purposes), you can create an OSGi run configuration. However, you will encounter dependency conflicts because the project is designed to run in Spring Boot, not Felix.

### Create Run Configuration (For Experimentation Only)

1. Go to **Run** -> **Edit Configurations**

2. Click the **+** (Add) button in the top-left corner

3. Select **OSGi Bundles** from the list

4. Configure the run configuration:

   - **Name**: Enter a name like `Hotel SmartTrack OSGi`
   - **OSGi Framework**: Select the Felix framework you configured in Step 3
   - **Working Directory**: Set to your project's target directory (optional)

5. In the **Bundles** section:

   - Click **+** to add bundles
   - Add your project modules (they will appear as bundles)
   - Check "Run all dependencies" to include required bundles automatically

6. In the **Parameters** tab (optional):

   - You can configure additional Felix parameters
   - Set the storage directory for bundle cache

7. Click **Apply** and **OK**

### Running the Configuration

1. Select your OSGi run configuration from the dropdown in the toolbar

2. Click the **Run** button (or press `Shift+F10`)

3. The Felix container will start and load your bundles

4. You'll see the **Gogo Shell** terminal where you can:
   - Type `lb` to list all bundles
   - Type `start <bundle-id>` to start a bundle
   - Type `stop <bundle-id>` to stop a bundle

---

## How This Project Uses OSGi with Maven

The Hotel SmartTrack project is already configured to work with OSGi through Maven. Here's how it works:

### Project Structure

```
hotel-smarttrack/
├── pom.xml                      # Parent POM with OSGi plugin configuration
├── smarttrack-base-library/     # Shared entities and interfaces (OSGi bundle)
├── smarttrack-guest/            # Guest management (OSGi bundle)
├── smarttrack-room/             # Room management (OSGi bundle)
├── smarttrack-reservation/      # Reservation management (OSGi bundle)
├── smarttrack-stay/             # Stay management (OSGi bundle)
├── smarttrack-billing/          # Billing management (OSGi bundle)
└── smarttrack-application/      # Spring Boot entry point
```

### Maven Bundle Plugin

Each module uses the `maven-bundle-plugin` from Apache Felix to generate OSGi-compliant bundles.

**Parent POM Configuration** (`pom.xml`):

```xml
<plugin>
    <groupId>org.apache.felix</groupId>
    <artifactId>maven-bundle-plugin</artifactId>
    <version>5.1.9</version>
    <extensions>true</extensions>
    <configuration>
        <instructions>
            <Bundle-SymbolicName>${project.artifactId}</Bundle-SymbolicName>
            <Bundle-Version>${project.version}</Bundle-Version>
            <Bundle-Vendor>Hotel SmartTrack</Bundle-Vendor>
        </instructions>
    </configuration>
</plugin>
```

### Bundle Packaging

Each business module declares `<packaging>bundle</packaging>` in its POM:

**Example** (`smarttrack-guest/pom.xml`):

```xml
<packaging>bundle</packaging>

<build>
    <plugins>
        <plugin>
            <groupId>org.apache.felix</groupId>
            <artifactId>maven-bundle-plugin</artifactId>
            <configuration>
                <instructions>
                    <!-- Import packages from base library -->
                    <Import-Package>
                        com.hotelsmarttrack.base.entity,
                        com.hotelsmarttrack.base.service,
                        org.springframework.stereotype,
                        *;resolution:=optional
                    </Import-Package>
                    <!-- Keep implementation private (encapsulation) -->
                    <Private-Package>com.hotelsmarttrack.guest.*</Private-Package>
                    <!-- No exports - only interfaces from base library are exposed -->
                    <Export-Package></Export-Package>
                </instructions>
            </configuration>
        </plugin>
    </plugins>
</build>
```

### How Maven and IntelliJ Work Together

1. **Build with Maven**: Run `mvn clean install` from the project root

   - This generates JAR files with proper OSGi manifests in each module's `target/` folder

2. **IntelliJ Reads the Manifests**: The OSGi facet in IntelliJ reads the generated `MANIFEST.MF` files

3. **Run in Felix**: Use the OSGi run configuration to deploy bundles to the Felix container

### Building the Project

Before running in the OSGi container, always build with Maven first:

```bash
# From the project root directory
mvn clean install -DskipTests
```

This command:

- Compiles all modules
- Generates OSGi manifests using `maven-bundle-plugin`
- Creates bundle JAR files in each module's `target/` directory

---

## Troubleshooting

### Plugin Not Found

**Problem**: Can't find "OSGi" in the Plugins Marketplace

**Solution**:

- Make sure you're searching in the **Marketplace** tab, not **Installed**
- Try restarting IntelliJ and searching again
- Check your internet connection

### Framework Not Detected

**Problem**: IntelliJ doesn't detect the Felix framework

**Solution**:

- Ensure you're pointing to the correct directory (the one containing `felix.jar`)
- Re-extract the Felix distribution if files are corrupted

### Bundles Not Starting

**Problem**: Bundles fail to start in the OSGi container

**Solution**:

1. Run `mvn clean install` to rebuild all bundles
2. Check the OSGi console for error messages
3. Verify all dependencies are resolved (use `lb` command)

### Missing Dependencies

**Problem**: Bundle reports missing imports

**Solution**:

- Ensure all required bundles are included in the run configuration
- Check the `Import-Package` declarations in the module's POM
- Add missing framework bundles from Felix's `bundle/` directory

---

## Additional Resources

- [Apache Felix Documentation](https://felix.apache.org/documentation.html)
- [OSGi Alliance Specifications](https://www.osgi.org/developer/specifications/)
- [IntelliJ IDEA OSGi Support Documentation](https://www.jetbrains.com/help/idea/osgi.html)
- [Maven Bundle Plugin Documentation](https://felix.apache.org/documentation/subprojects/apache-felix-maven-bundle-plugin-bnd.html)
